name: Release

on:
  schedule:
    # Nightly at midnight Eastern Time (5 AM UTC during EST)
    - cron: '0 5 * * *'
    # Weekly on Sunday at midnight Eastern Time
    - cron: '0 5 * * 0'
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'nightly'
        type: choice
        options:
          - nightly
          - weekly
          - patch
          - minor
          - major
      dry_run:
        description: 'Dry run (no actual release)'
        required: false
        default: false
        type: boolean

jobs:
  determine-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      release_type: ${{ steps.type.outputs.release_type }}
      is_prerelease: ${{ steps.type.outputs.is_prerelease }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Determine release type
        id: type
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RELEASE_TYPE="${{ github.event.inputs.release_type }}"
          elif [ "${{ github.event.schedule }}" = "0 5 * * 0" ]; then
            RELEASE_TYPE="weekly"
          else
            RELEASE_TYPE="nightly"
          fi

          echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT

          if [ "$RELEASE_TYPE" = "nightly" ] || [ "$RELEASE_TYPE" = "weekly" ]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

          echo "Release type: $RELEASE_TYPE"

      - name: Get latest tag
        id: latest_tag
        run: |
          LATEST_TAG=$(git tag -l 'v*' | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | sort -V | tail -n1)
          if [ -z "$LATEST_TAG" ]; then
            LATEST_TAG="v0.7.0"
          fi
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Latest stable tag: $LATEST_TAG"

      - name: Calculate new version
        id: version
        run: |
          LATEST="${{ steps.latest_tag.outputs.latest_tag }}"
          RELEASE_TYPE="${{ steps.type.outputs.release_type }}"
          DATE=$(date +%Y%m%d)

          VERSION=${LATEST#v}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)

          case $RELEASE_TYPE in
            nightly)
              NEW_VERSION="v${MAJOR}.${MINOR}.$((PATCH + 1))-nightly.${DATE}"
              ;;
            weekly)
              NEW_VERSION="v${MAJOR}.${MINOR}.$((PATCH + 1))-weekly.${DATE}"
              ;;
            patch)
              NEW_VERSION="v${MAJOR}.${MINOR}.$((PATCH + 1))"
              ;;
            minor)
              NEW_VERSION="v${MAJOR}.$((MINOR + 1)).0"
              ;;
            major)
              NEW_VERSION="v$((MAJOR + 1)).0.0"
              ;;
          esac

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "New version: $NEW_VERSION"

  release:
    needs: determine-version
    runs-on: ubuntu-latest
    if: ${{ github.event.inputs.dry_run != 'true' }}
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 0

      - name: Create plugin archives
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          VERSION_NUM=${VERSION#v}

          mkdir -p dist

          # Create archive for each plugin
          for plugin in plugins/*/; do
            plugin_name=$(basename "$plugin")
            echo "Packaging $plugin_name..."

            # Create tarball
            tar -czf "dist/${plugin_name}-${VERSION_NUM}.tar.gz" -C plugins "$plugin_name"

            # Create zip
            cd plugins && zip -r "../dist/${plugin_name}-${VERSION_NUM}.zip" "$plugin_name" && cd ..
          done

          # Create full marketplace archive
          tar -czf "dist/kubestellar-plugins-${VERSION_NUM}.tar.gz" \
            plugins/ \
            .claude-plugin/ \
            README.md \
            LICENSE

          zip -r "dist/kubestellar-plugins-${VERSION_NUM}.zip" \
            plugins/ \
            .claude-plugin/ \
            README.md \
            LICENSE

          # Create checksums
          cd dist && sha256sum *.tar.gz *.zip > checksums.txt && cd ..

          ls -la dist/

      - name: Create and push tag
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check if tag exists
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "Tag $VERSION already exists, force updating..."
            git tag -d "$VERSION"
            git push origin ":refs/tags/$VERSION" || true
          fi

          git tag -a "$VERSION" -m "Release $VERSION"
          git push origin "$VERSION"

      - name: Generate changelog
        id: changelog
        run: |
          VERSION="${{ needs.determine-version.outputs.version }}"

          # Get commits since last tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$PREV_TAG" ]; then
            CHANGES=$(git log --pretty=format:"- %s" "$PREV_TAG"..HEAD)
          else
            CHANGES=$(git log --pretty=format:"- %s" -10)
          fi

          echo "changes<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@da05d552573ad5aba039eaac05058a918a7bf631 # v2.2.2
        with:
          tag_name: ${{ needs.determine-version.outputs.version }}
          name: ${{ needs.determine-version.outputs.version }}
          prerelease: ${{ needs.determine-version.outputs.is_prerelease == 'true' }}
          generate_release_notes: true
          files: |
            dist/*.tar.gz
            dist/*.zip
            dist/checksums.txt
          body: |
            ## KubeStellar Claude Plugins ${{ needs.determine-version.outputs.version }}

            ### Installation

            ```bash
            # Install from marketplace
            claude plugins install kubestellar/kubestellar-ops
            claude plugins install kubestellar/kubestellar-deploy

            # Or install from this release
            claude plugins install https://github.com/kubestellar/claude-plugins/releases/download/${{ needs.determine-version.outputs.version }}/kubestellar-ops-${{ needs.determine-version.outputs.version }}.tar.gz
            ```

            ### Plugins Included

            - **kubestellar-ops** - Multi-cluster Kubernetes diagnostics, RBAC analysis, and security checks
            - **kubestellar-deploy** - App-centric multi-cluster deployment with GitOps support

            ### Changes

            ${{ steps.changelog.outputs.changes }}

  notify:
    needs: [determine-version, release]
    runs-on: ubuntu-latest
    if: always() && needs.release.result != 'skipped'
    steps:
      - name: Release summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ needs.determine-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Type**: ${{ needs.determine-version.outputs.release_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Pre-release**: ${{ needs.determine-version.outputs.is_prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ${{ needs.release.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.release.result }}" = "success" ]; then
            echo "### Install" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
            echo "claude plugins install kubestellar/kubestellar-ops" >> $GITHUB_STEP_SUMMARY
            echo "claude plugins install kubestellar/kubestellar-deploy" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
